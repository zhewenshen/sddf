/* untested */
#define ETH_MAC_BASE    pnk_mem(0)
#define IRQ_CH          pnk_mem(1)
#define RX_CH           pnk_mem(2)
#define TX_CH           pnk_mem(3)
#define NET_RX_FREE     pnk_mem(4)
#define NET_RX_ACTIVE   pnk_mem(5)
#define NET_RX_CAPACITY pnk_mem(6)
#define NET_TX_FREE     pnk_mem(7)
#define NET_TX_ACTIVE   pnk_mem(8)
#define NET_TX_CAPACITY pnk_mem(9)

#define HW_RX_PTR       pnk_mem_ptr(10)
#define HW_RX_TAIL_SLOT pnk_mem_ptr(10)
#define HW_RX_HEAD_SLOT pnk_mem_ptr(11)
#define HW_RX_TAIL      lds 1 HW_RX_TAIL_SLOT
#define HW_RX_HEAD      lds 1 HW_RX_HEAD_SLOT
#define HW_RX_CAPACITY  pnk_mem(12)
#define HW_RX_DESCR     pnk_mem(13)

#define HW_TX_PTR       pnk_mem_ptr(14)
#define HW_TX_TAIL_SLOT pnk_mem_ptr(14)
#define HW_TX_HEAD_SLOT pnk_mem_ptr(15)
#define HW_TX_TAIL      lds 1 HW_TX_TAIL_SLOT
#define HW_TX_HEAD      lds 1 HW_TX_HEAD_SLOT
#define HW_TX_CAPACITY  pnk_mem(16)
#define HW_TX_DESCR     pnk_mem(17)

#define RX_DESC_BASE    pnk_mem(18)
#define TX_DESC_BASE    pnk_mem(19)

#define RX_METADATA_BASE pnk_mem(20)
#define TX_METADATA_BASE pnk_mem(21)

fun rx_hw_ring_empty() {
  var tail = HW_RX_TAIL;
  var head = HW_RX_HEAD;
  var ret = (head == tail);
  return ret;
}

fun tx_hw_ring_empty() {
  var tail = HW_TX_TAIL;
  var head = HW_TX_HEAD;
  var ret = (head == tail);
  return ret;
}

fun rx_hw_ring_full() {
  var tail = HW_RX_TAIL;
  var head = HW_RX_HEAD;
  var ret = (tail - head) == HW_RX_CAPACITY;
  return ret;
}

fun tx_hw_ring_full() {
  var tail = HW_TX_TAIL;
  var head = HW_TX_HEAD;
  var ret = (tail - head) == HW_TX_CAPACITY;
  return ret;
}

#define MAX_RX_FRAME_SZ             1536
#define RX_COUNT                    256
#define TX_COUNT                    256
#define DESCRIPTOR_SIZE             16

#define MAC_CONFIGURATION           0
#define MAC_PACKET_FILTER           8
#define MAC_Q0_TX_FLOW_CTRL         112
#define MAC_RX_FLOW_CTRL            144
#define MAC_TXQ_PRTY_MAP0           152
#define MAC_RXQ_CTRL0               160
#define MAC_INTERRUPT_STATUS        176
#define MAC_INTERRUPT_ENABLE        180
#define MAC_PHYIF_CONTROL_STATUS    248
#define MAC_HW_FEATURE1             288
#define MAC_ADDRESS0_HIGH           768
#define MAC_ADDRESS0_LOW            772

#define MAC_CONFIG_RE               1
#define MAC_CONFIG_TE               2
#define MAC_CONFIG_DM               8192
#define MAC_CONFIG_FES              16384
#define MAC_CONFIG_PS               32768
#define MAC_CONFIG_JE               65536
#define MAC_CONFIG_JB               131072
#define MAC_CONFIG_WB               524288
#define MAC_CONFIG_ACS              1048576
#define MAC_CONFIG_CST              2097152
#define MAC_CONFIG_GPSLCE           8388608
#define MAC_CONFIG_IPC              134217728

#define MAC_PACKET_FILTER_PR        1

#define MAC_RXQ_CTRL0_Q0_CLEAR      3
#define MAC_RXQ_CTRL0_Q0_DCB_GEN_EN 2

#define MAC_PHYIF_CONTROL_LINKSTS   524288

#define MTL_OPERATION_MODE          3072
#define MTL_RXQ_DMA_MAP0            3120
#define MTL_TXQ0_OPERATION_MODE     3328
#define MTL_TXQ0_DEBUG              3336
#define MTL_Q0_INT_CTRL_STATUS      3372
#define MTL_RXQ0_OPERATION_MODE     3376
#define MTL_RXQ0_DEBUG              3384
#define MTL_RXQ0_CONTROL            3388

#define MTL_RXQ_DMA_MAP0_Q0_MDMACH_MASK  7
#define MTL_TXQ_OP_MODE_TSF         2
#define MTL_TXQ_OP_MODE_TXQEN       8
#define MTL_TXQ_OP_MODE_TQS_POS     16
#define MTL_TXQ_OP_MODE_TQS_MASK    2031616
#define MTL_RXQ_OP_MODE_RSF         32
#define MTL_RXQ_OP_MODE_RQS_POS     20
#define MTL_RXQ_OP_MODE_RQS_MASK    2013265920

#define DMA_MODE                    4096
#define DMA_CH0_TX_CONTROL          4356
#define DMA_CH0_RX_CONTROL          4360
#define DMA_CH0_TXDESC_LIST_ADDR    4372
#define DMA_CH0_RXDESC_LIST_ADDR    4380
#define DMA_CH0_TXDESC_TAIL_PTR     4384
#define DMA_CH0_RXDESC_TAIL_PTR     4392
#define DMA_CH0_TXDESC_RING_LENGTH  4396
#define DMA_CH0_RXDESC_RING_LENGTH  4400
#define DMA_CH0_INTERRUPT_EN        4404
#define DMA_CH0_STATUS              4448

#define DMA_MODE_SWR                1

#define DMA_CH0_TX_CONTROL_ST       1
#define DMA_CH0_TX_CONTROL_OSF      16

#define DMA_CH0_RX_CONTROL_SR       1
#define DMA_CH0_RX_RBSZ_POS         1
#define DMA_CH0_RX_RBSZ_MASK        32766

#define DMA_CH0_INTERRUPT_EN_TIE    1
#define DMA_CH0_INTERRUPT_EN_TBUE   2
#define DMA_CH0_INTERRUPT_EN_RIE    64
#define DMA_CH0_INTERRUPT_EN_RBUE   128
#define DMA_CH0_INTERRUPT_EN_RSE    256
#define DMA_CH0_INTERRUPT_EN_RWTE   512
#define DMA_CH0_INTERRUPT_EN_ETIE   1024
#define DMA_CH0_INTERRUPT_EN_ERIE   2048
#define DMA_CH0_INTERRUPT_EN_FBEE   4096
#define DMA_CH0_INTERRUPT_EN_CDEE   8192
#define DMA_CH0_INTERRUPT_EN_AIE    16384
#define DMA_CH0_INTERRUPT_EN_NIE    32768

#define DMA_INTR_NORMAL    32833
#define DMA_INTR_ABNORMAL  20480
#define DMA_INTR_MASK      53313

#define DESC_RXSTS_OWNBYDMA           2147483648
#define DESC_RXSTS_BUFFER1_ADDR_VALID 16777216
#define DESC_RXSTS_IOC                1073741824
#define DESC_RXSTS_LENMSK             1073676288
#define DESC_RXSTS_LENSHFT            16
#define DESC_RXSTS_ERROR              32768
#define DESC_RXSTS_RXTRUNCATED        16384
#define DESC_RXSTS_SAFILTERFAIL       8192
#define DESC_RXSTS_RXIPC_GIANTFRAME   4096
#define DESC_RXSTS_RXDAMAGED          2048
#define DESC_RXSTS_RXVLANTAG          1024
#define DESC_RXSTS_RXFIRST            512
#define DESC_RXSTS_RXLAST             256
#define DESC_RXSTS_RXIPC_GIANT        128
#define DESC_RXSTS_RXCOLLISION        64
#define DESC_RXSTS_RXFRAMEETHER       32
#define DESC_RXSTS_RXWATCHDOG         16
#define DESC_RXSTS_RXMIIERROR         8
#define DESC_RXSTS_RXDRIBBLING        4
#define DESC_RXSTS_RXCRC              2
#define DESC_RXSTS_RXMAC              1

#define DESC_RXCTRL_RXINTDIS          2147483648
#define DESC_RXCTRL_RXRINGEND         33554432
#define DESC_RXCTRL_RXCHAIN           16777216
#define DESC_RXCTRL_SIZE2MASK         4190208
#define DESC_RXCTRL_SIZE2SHFT         11
#define DESC_RXCTRL_SIZE1MASK         2047
#define DESC_RXCTRL_SIZE1SHFT         0

#define DESC_TXSTS_OWNBYDMA           2147483648

#define DESC_TXCTRL_TXINT             2147483648
#define DESC_TXCTRL_TXLAST            268435456
#define DESC_TXCTRL_TXFIRST           536870912
#define DESC_TXCTRL_TXCRCDIS          67108864
#define DESC_TXCTRL_TXRINGEND         33554432
#define DESC_TXCTRL_TXCHAIN           16777216
#define DESC_TXCTRL_TXCIC             196608
#define DESC_TXCTRL_SIZE2MASK         4190208
#define DESC_TXCTRL_SIZE2SHFT         11
#define DESC_TXCTRL_SIZE1MASK         2047
#define DESC_TXCTRL_SIZE1SHFT         0

fun mac_reg_read(1 offset) {
  var addr = ETH_MAC_BASE + offset;
  var value = 0;
  !ld32 value, addr;
  return value;
}

fun mac_reg_write(1 offset, 1 value) {
  var addr = ETH_MAC_BASE + offset;
  !st32 addr, value;
  return 0;
}

fun mtl_reg_read(1 offset) {
  var addr = ETH_MAC_BASE + offset;
  var value = 0;
  !ld32 value, addr;
  return value;
}

fun mtl_reg_write(1 offset, 1 value) {
  var addr = ETH_MAC_BASE + offset;
  !st32 addr, value;
  return 0;
}

fun dma_reg_read(1 offset) {
  var addr = ETH_MAC_BASE + offset;
  var value = 0;
  !ld32 value, addr;
  return value;
}

fun dma_reg_write(1 offset, 1 value) {
  var addr = ETH_MAC_BASE + offset;
  !st32 addr, value;
  return 0;
}

fun get_dma_status() {
  var status = 0;
  status = dma_reg_read(DMA_CH0_STATUS);
  dma_reg_write(DMA_CH0_STATUS, status);
  return status;
}

fun rx_update_ring_slot(1 idx, 1 buffer_addr_low, 1 buffer_addr_high, 1 des2, 1 des3) {
  var descr_base = HW_RX_DESCR;
  var descr = descr_base + idx * DESCRIPTOR_SIZE;
  
  !st32 descr, buffer_addr_low;
  !st32 descr + 4, buffer_addr_high;
  !st32 descr + 8, des2;
  
  THREAD_MEMORY_RELEASE()
  
  !st32 descr + 12, des3;
  return 0;
}

fun tx_update_ring_slot(1 idx, 1 buffer_addr_low, 1 buffer_addr_high, 1 des2, 1 des3) {
  var descr_base = HW_TX_DESCR;
  var descr = descr_base + idx * DESCRIPTOR_SIZE;
  
  !st32 descr, buffer_addr_low;
  !st32 descr + 4, buffer_addr_high;
  !st32 descr + 8, des2;
  
  THREAD_MEMORY_RELEASE()
  
  !st32 descr + 12, des3;
  return 0;
}

fun store_rx_metadata(1 idx, 1 io_addr, 1 cookie) {
  var metadata_base = RX_METADATA_BASE;
  var metadata_addr = metadata_base + idx * 16;
  
  !stw metadata_addr, io_addr;
  !stw metadata_addr + 8, cookie;
  return 0;
}

fun store_tx_metadata(1 idx, 1 io_addr, 1 cookie) {
  var metadata_base = TX_METADATA_BASE;
  var metadata_addr = metadata_base + idx * 16;
  
  !stw metadata_addr, io_addr;
  !stw metadata_addr + 8, cookie;
  return 0;
}

fun get_rx_metadata(1 idx) {
  var metadata_base = RX_METADATA_BASE;
  var metadata_addr = metadata_base + idx * 16;
  
  var io_addr = 0;
  var cookie = 0;
  !ldw io_addr, metadata_addr;
  !ldw cookie, metadata_addr + 8;
  
  return <io_addr, cookie>;
}

fun get_tx_metadata(1 idx) {
  var metadata_base = TX_METADATA_BASE;
  var metadata_addr = metadata_base + idx * 16;
  
  var io_addr = 0;
  var cookie = 0;
  !ldw io_addr, metadata_addr;
  !ldw cookie, metadata_addr + 8;
  
  return <io_addr, cookie>;
}

fun rx_provide() {
  var reprocess = 1;
  while (reprocess) {
    while (1) {
      var 1 hw_full = rx_hw_ring_full();
      if (hw_full) { break; }
      
      var 1 queue_empty = net_queue_empty(NET_RX_FREE);
      if (queue_empty) { break; }
      
      var {1,1} buffer = net_dequeue(NET_RX_FREE, NET_RX_CAPACITY);
      var io_addr = buffer.0;
      var len = buffer.1;
      
      var tail = HW_RX_TAIL;
      var capacity = HW_RX_CAPACITY;
      var idx = tail;
      while (idx >= capacity) {
        idx = idx - capacity;
      }
      store_rx_metadata(idx, io_addr, len);
      
      var addr_low = io_addr & 4294967295;
      var addr_high = io_addr >> 32;
      var des2 = 0;
      var des3 = DESC_RXSTS_OWNBYDMA | DESC_RXSTS_BUFFER1_ADDR_VALID | DESC_RXSTS_IOC;
      rx_update_ring_slot(idx, addr_low, addr_high, des2, des3);
      
      THREAD_MEMORY_RELEASE()
      var tail_addr = RX_DESC_BASE + DESCRIPTOR_SIZE * tail;
      dma_reg_write(DMA_CH0_RXDESC_TAIL_PTR, tail_addr);
      
      tail = tail + 1;
      !stw HW_RX_TAIL_SLOT, tail;
    }
    
    net_request_signal(NET_RX_FREE);
    reprocess = 0;
    
    var 1 queue_empty = net_queue_empty(NET_RX_FREE);
    var 1 hw_full = rx_hw_ring_full();
    if (!queue_empty && !hw_full) {
      net_cancel_signal(NET_RX_FREE);
      reprocess = 1;
    }
  }
  return 0;
}

fun rx_return() {
  var packets_transferred = 0;
  
  var 1 hw_empty = rx_hw_ring_empty();
  while (!hw_empty) {
    var head = HW_RX_HEAD;
    var capacity = HW_RX_CAPACITY;
    var idx = head;
    while (idx >= capacity) {
      idx = idx - capacity;
    }
    
    var descr_base = HW_RX_DESCR;
    var descr = descr_base + idx * DESCRIPTOR_SIZE;
    var des3 = 0;
    !ld32 des3, descr + 12;
    
    if (des3 & DESC_RXSTS_OWNBYDMA) {
      return packets_transferred;
    }
    
    THREAD_MEMORY_ACQUIRE()
    
    var {1,1} metadata = get_rx_metadata(idx);
    var io_addr = metadata.0;
    var cookie = metadata.1;
    
    if (des3 & DESC_RXSTS_ERROR) {
      var tail = HW_RX_TAIL;
      idx = tail;
      while (idx >= capacity) {
        idx = idx - capacity;
      }
      store_rx_metadata(idx, io_addr, cookie);
      
      var addr_low = io_addr & 4294967295;
      var addr_high = io_addr >> 32;
      var des2 = 0;
      des3 = DESC_RXSTS_OWNBYDMA | DESC_RXSTS_BUFFER1_ADDR_VALID | DESC_RXSTS_IOC;
      rx_update_ring_slot(idx, addr_low, addr_high, des2, des3);
      
      var tail_addr = RX_DESC_BASE + DESCRIPTOR_SIZE * idx;
      dma_reg_write(DMA_CH0_RXDESC_TAIL_PTR, tail_addr);
      
      tail = tail + 1;
      !stw HW_RX_TAIL_SLOT, tail;
    } else {
      var len = (des3 & 32767);
      
      net_enqueue(NET_RX_ACTIVE, io_addr, len, NET_RX_CAPACITY);
      packets_transferred = 1;
    }
    
    head = head + 1;
    !stw HW_RX_HEAD_SLOT, head;
    
    hw_empty = rx_hw_ring_empty();
  }
  
  if (packets_transferred) {
    var 1 requires_signal = net_require_signal(NET_RX_ACTIVE);
    if (requires_signal) {
      net_cancel_signal(NET_RX_ACTIVE);
      microkit_notify(RX_CH)
    }
  }
  
  return packets_transferred;
}

fun tx_provide() {
  var reprocess = 1;
  while (reprocess) {
    while (1) {
      var 1 hw_full = tx_hw_ring_full();
      if (hw_full) { break; }
      
      var 1 queue_empty = net_queue_empty(NET_TX_ACTIVE);
      if (queue_empty) { break; }
      
      var {1,1} buffer = net_dequeue(NET_TX_ACTIVE, NET_TX_CAPACITY);
      var io_addr = buffer.0;
      var len = buffer.1;
      
      var tail = HW_TX_TAIL;
      var capacity = HW_TX_CAPACITY;
      var idx = tail;
      while (idx >= capacity) {
        idx = idx - capacity;
      }
      store_tx_metadata(idx, io_addr, len);
      
      var addr_low = io_addr & 4294967295;
      var addr_high = io_addr >> 32;
      var des2 = DESC_TXCTRL_TXINT | len;
      var des3 = DESC_TXSTS_OWNBYDMA | DESC_TXCTRL_TXFIRST | DESC_TXCTRL_TXLAST | DESC_TXCTRL_TXCIC | len;
      tx_update_ring_slot(idx, addr_low, addr_high, des2, des3);
      
      tail = tail + 1;
      !stw HW_TX_TAIL_SLOT, tail;
      
      var tail_addr = TX_DESC_BASE + DESCRIPTOR_SIZE * idx;
      dma_reg_write(DMA_CH0_TXDESC_TAIL_PTR, tail_addr);
    }
    
    net_request_signal(NET_TX_ACTIVE);
    reprocess = 0;
    
    var 1 hw_full = tx_hw_ring_full();
    var 1 queue_empty = net_queue_empty(NET_TX_ACTIVE);
    if (!hw_full && !queue_empty) {
      net_cancel_signal(NET_TX_ACTIVE);
      reprocess = 1;
    }
  }
  return 0;
}

fun tx_return() {
  var enqueued = 0;
  
  var 1 hw_empty = tx_hw_ring_empty();
  while (!hw_empty) {
    var head = HW_TX_HEAD;
    var capacity = HW_TX_CAPACITY;
    var idx = head;
    while (idx >= capacity) {
      idx = idx - capacity;
    }
    
    var descr_base = HW_TX_DESCR;
    var descr = descr_base + idx * DESCRIPTOR_SIZE;
    var des3 = 0;
    !ld32 des3, descr + 12;
    
    if (des3 & DESC_TXSTS_OWNBYDMA) {
      return enqueued;
    }
    
    THREAD_MEMORY_ACQUIRE()
    
    var {1,1} metadata = get_tx_metadata(idx);
    var io_addr = metadata.0;
    var cookie = metadata.1;
    
    net_enqueue(NET_TX_FREE, io_addr, 0, NET_TX_CAPACITY);
    enqueued = 1;
    
    head = head + 1;
    !stw HW_TX_HEAD_SLOT, head;
    
    hw_empty = tx_hw_ring_empty();
  }
  
  if (enqueued) {
    var 1 requires_signal = net_require_signal(NET_TX_FREE);
    if (requires_signal) {
      net_cancel_signal(NET_TX_FREE);
      microkit_notify(TX_CH)
    }
  }
  
  return enqueued;
}

fun handle_irq() {
  var 1 status = get_dma_status();
  
  while (status & DMA_INTR_MASK) {
    if (status & DMA_CH0_INTERRUPT_EN_TIE) {
      tx_return();
      tx_provide();
    }
    
    if (status & DMA_CH0_INTERRUPT_EN_RIE) {
      rx_return();
    }
    
    if (status & DMA_INTR_ABNORMAL) {
      if (status & DMA_CH0_INTERRUPT_EN_FBEE) {
        @assert(0,0,0,0);
      }
    }
    
    status = get_dma_status();
  }
  
  return 0;
}

fun main() {
  rx_provide();
  tx_provide();

  return 0;
}

export fun notified(1 ch) {
  if (ch == IRQ_CH) {
    handle_irq();
    microkit_deferred_irq_ack(ch)
  }
  if (ch == RX_CH) {
    rx_provide();
  }
  if (ch == TX_CH) {
    tx_provide();
  }
  if ((ch != IRQ_CH) && (ch != RX_CH) && (ch != TX_CH)) {
    @assert(0,0,0,0);
  }
  return 0;
}
